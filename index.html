<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<!-- =========================================================
     APP IDENTITY ‚Äî v3.0 FINAL
========================================================= -->
<title>Barefeetmv.Kanmathi-Island.Man v3.0</title>
<meta name="application-name" content="Barefeetmv.Kanmathi-Island.Man">
<meta name="viewport"
      content="width=device-width,
               initial-scale=1,
               maximum-scale=1,
               user-scalable=no,
               viewport-fit=cover">
<meta name="theme-color" content="#38bdf8">
<meta name="screen-orientation" content="portrait">
<meta name="orientation" content="portrait">

<!-- =========================================================
     PWA MANIFEST
========================================================= -->
<link rel="manifest" href="data:application/manifest+json,{
  &quot;name&quot;:&quot;Barefeetmv.Kanmathi-Island.Man&quot;,
  &quot;short_name&quot;:&quot;Kanmathi&quot;,
  &quot;description&quot;:&quot;A minimalist puzzle game inspired by Threes.&quot;,
  &quot;start_url&quot;:&quot;.&quot;,
  &quot;display&quot;:&quot;standalone&quot;,
  &quot;background_color&quot;:&quot;#0b1220&quot;,
  &quot;theme_color&quot;:&quot;#38bdf8&quot;,
  &quot;orientation&quot;:&quot;portrait&quot;
}">

<link rel="icon" href="data:image/svg+xml,
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
<text y='.9em' font-size='90'>üèùÔ∏è</text>
</svg>">

<style>
/* =========================================================
   HARD LOCK ‚Äî NO SCROLL / NO BOUNCE / NO ZOOM
========================================================= */
*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  position:fixed;
  overflow:hidden;
  overscroll-behavior:none;
  touch-action:none;
  -webkit-user-select:none;
  user-select:none;
  background:#0b1220;
  color:#fff;
  font-family:system-ui,-apple-system,Segoe UI,sans-serif;
}

/* =========================================================
   VERSION STAMP
========================================================= */
:root::after{
  content:"v3.0 FINAL";
  position:fixed;
  bottom:6px;
  right:10px;
  font-size:10px;
  opacity:.35;
  pointer-events:none;
}

/* =========================================================
   THEMES
========================================================= */
:root{
  --bg:#0b1220;
  --panel:#111827;
  --cell:#1f2937;
  --text:#fff;
  --accent:#38bdf8;
  --c1:#38bdf8;
  --c2:#facc15;
  --c3:#22c55e;
}
.light{
  --bg:#e5e7eb;
  --panel:#f9fafb;
  --cell:#d1d5db;
  --text:#111827;
}
.cb{
  --c1:#2563eb;
  --c2:#d97706;
  --c3:#7c3aed;
}

/* =========================================================
   LAYOUT
========================================================= */
body{
  display:flex;
  justify-content:center;
  align-items:center;
  padding:
    env(safe-area-inset-top)
    env(safe-area-inset-right)
    env(safe-area-inset-bottom)
    env(safe-area-inset-left);
}
#game{
  background:var(--panel);
  width:320px;
  padding:14px;
  border-radius:18px;
  box-shadow:0 20px 50px rgba(0,0,0,.45);
  animation:boot .45s ease forwards;
}
@keyframes boot{from{opacity:0;transform:scale(.92)}}

#hud{
  display:flex;
  justify-content:space-between;
  font-weight:800;
  margin-bottom:8px;
}
#score.bump{animation:bump .18s}
@keyframes bump{50%{transform:scale(1.25)}}

.grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
}
.cell{
  height:64px;
  border-radius:10px;
  background:var(--cell);
  position:relative;
}
.tile{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:10px;
  font-weight:900;
  font-size:22px;
  animation:pop .14s ease-out;
}
@keyframes pop{from{transform:scale(.85)}}

/* =========================================================
   TILE COLORS
========================================================= */
[data-v="1"]{background:var(--c1)}
[data-v="2"]{background:var(--c2);color:#111}
[data-v="3"]{background:var(--c3)}
[data-v="6"]{background:#4ade80}
[data-v="12"]{background:#86efac;color:#064e3b}
[data-v="24"]{background:#bbf7d0;color:#064e3b}
[data-v="48"]{background:#f472b6}
[data-v="96"]{background:#fb7185}
[data-v="192"]{background:#f97316}

/* =========================================================
   CONTROLS
========================================================= */
.controls{
  display:flex;
  gap:6px;
  margin-top:8px;
}
button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:10px;
  font-weight:800;
  background:var(--accent);
  color:#062a36;
}

/* =========================================================
   OVERLAYS
========================================================= */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.panel{
  background:var(--panel);
  padding:22px;
  border-radius:16px;
  text-align:center;
  width:260px;
}
.hidden{display:none}
</style>
</head>

<body>

<div id="game">
  <div id="hud">
    <div>Score <span id="score">0</span></div>
    <div>Best <span id="best">0</span></div>
  </div>
  <div class="grid" id="grid"></div>
  <div class="controls">
    <button id="undoBtn">Undo</button>
    <button id="themeBtn">Theme</button>
    <button id="cbBtn">CB</button>
    <button id="restartBtn">Restart</button>
  </div>
</div>

<div id="tutorial" class="overlay hidden">
  <div class="panel">
    <h3>How to Play</h3>
    <p>Swipe up, down, left or right to combine tiles.</p>
    <button id="startBtn">Start</button>
  </div>
</div>

<div id="end" class="overlay hidden">
  <div class="panel">
    <h2>Game Over</h2>
    <h1 id="endScore">0</h1>
    <button id="playAgainBtn">Play Again</button>
  </div>
</div>

<script>
/* =========================================================
   ENGINE ‚Äî v3.0 FINAL
========================================================= */
(() => {
'use strict';

/* ---------- ORIENTATION ---------- */
if (screen.orientation?.lock) {
  screen.orientation.lock("portrait").catch(()=>{});
}

/* ---------- CONSTANTS ---------- */
const SIZE = 4;
const DEAD_ZONE = 24;
const SWIPE_THRESHOLD = 30;

/* ---------- STATE ---------- */
let grid = [];
let score = 0;
let best = Number(localStorage.getItem("bf_best_v3")) || 0;
let history = [];
let over = false;

/* ---------- ELEMENTS ---------- */
const gridEl = document.getElementById("grid");
const scoreEl = document.getElementById("score");
const bestEl = document.getElementById("best");
const endEl = document.getElementById("end");
const endScoreEl = document.getElementById("endScore");
const tutorialEl = document.getElementById("tutorial");

/* ---------- INIT HUD ---------- */
bestEl.textContent = best;

/* ---------- AUDIO ---------- */
let soundEnabled = localStorage.getItem("bf_sound_v3") !== "0";
let audioCtx;
function beep(freq){
  if(!soundEnabled) return;
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  audioCtx.resume();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.frequency.value = freq;
  g.gain.value = .04;
  o.connect(g).connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + .05);
}
function haptic(pattern){
  if(navigator.vibrate) navigator.vibrate(pattern);
}

/* ---------- GAME ---------- */
function reset(){
  grid = Array.from({length:SIZE},()=>Array(SIZE).fill(0));
  score = 0;
  history = [];
  over = false;
  spawn();
  spawn();
  render();
}
function spawn(){
  const empty=[];
  grid.forEach((r,y)=>r.forEach((v,x)=>!v&&empty.push({x,y})));
  if(!empty.length) return;
  const p = empty[Math.random()*empty.length|0];
  grid[p.y][p.x] = Math.random()<.5?1:2;
}
function move(dx,dy){
  if(over) return;
  history.push({g:grid.map(r=>r.slice()),s:score});
  let moved=false;
  const order=[0,1,2,3];
  if(dx>0||dy>0) order.reverse();
  for(const y of order)for(const x of order){
    let v=grid[y][x];
    if(!v) continue;
    let nx=x,ny=y;
    while(true){
      const tx=nx+dx,ty=ny+dy;
      if(tx<0||ty<0||tx>=SIZE||ty>=SIZE) break;
      const t=grid[ty][tx];
      if(!t){
        grid[ty][tx]=v;grid[ny][nx]=0;
        nx=tx;ny=ty;moved=true;
      }else if((v===1&&t===2)||(v===2&&t===1)){
        grid[ty][tx]=3;grid[ny][nx]=0;
        score+=3;beep(600);haptic(15);moved=true;break;
      }else if(v>=3&&v===t){
        grid[ty][tx]=v*2;grid[ny][nx]=0;
        score+=v*2;beep(800);haptic([10,20,10]);moved=true;break;
      }else break;
    }
  }
  if(moved){
    spawn();
    pulse();
    render();
    checkOver();
  }else{
    history.pop();
  }
}
function undo(){
  const p=history.pop();
  if(!p) return;
  grid=p.g;
  score=p.s;
  render();
  haptic(5);
}
function checkOver(){
  for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){
    if(!grid[y][x]) return;
    for(const[dX,dY] of [[1,0],[0,1],[-1,0],[0,-1]]){
      const nx=x+dX,ny=y+dY;
      if(nx>=0&&ny>=0&&nx<SIZE&&ny<SIZE){
        const a=grid[y][x],b=grid[ny][nx];
        if(a===b||a+b===3) return;
      }
    }
  }
  over=true;
  endScoreEl.textContent=score;
  endEl.classList.remove("hidden");
  haptic([40,30,40]);
}

/* ---------- RENDER ---------- */
function render(){
  gridEl.innerHTML="";
  scoreEl.textContent=score;
  if(score>best){
    best=score;
    localStorage.setItem("bf_best_v3",best);
    bestEl.textContent=best;
  }
  grid.forEach(r=>r.forEach(v=>{
    const c=document.createElement("div");
    c.className="cell";
    if(v){
      const t=document.createElement("div");
      t.className="tile";
      t.dataset.v=v;
      t.textContent=v;
      c.appendChild(t);
    }
    gridEl.appendChild(c);
  }));
}
function pulse(){
  scoreEl.classList.add("bump");
  setTimeout(()=>scoreEl.classList.remove("bump"),180);
}

/* ---------- INPUT ---------- */
let sx=0,sy=0;
addEventListener("touchstart",e=>{
  const t=e.touches[0];
  if(t.clientX<DEAD_ZONE||t.clientY<DEAD_ZONE||
     t.clientX>innerWidth-DEAD_ZONE||
     t.clientY>innerHeight-DEAD_ZONE) return;
  sx=t.clientX;sy=t.clientY;
},{passive:false});

addEventListener("touchend",e=>{
  const t=e.changedTouches[0];
  const dx=t.clientX-sx;
  const dy=t.clientY-sy;
  if(Math.abs(dx)<SWIPE_THRESHOLD&&Math.abs(dy)<SWIPE_THRESHOLD) return;
  Math.abs(dx)>Math.abs(dy)
    ? move(dx>0?1:-1,0)
    : move(0,dy>0?1:-1);
},{passive:false});

addEventListener("keydown",e=>{
  if(e.key==="ArrowLeft")move(-1,0);
  if(e.key==="ArrowRight")move(1,0);
  if(e.key==="ArrowUp")move(0,-1);
  if(e.key==="ArrowDown")move(0,1);
});

/* ---------- UI ---------- */
document.getElementById("undoBtn").onclick=undo;
document.getElementById("restartBtn").onclick=()=>{endEl.classList.add("hidden");reset()};
document.getElementById("playAgainBtn").onclick=()=>{endEl.classList.add("hidden");reset()};
document.getElementById("themeBtn").onclick=()=>document.body.classList.toggle("light");
document.getElementById("cbBtn").onclick=()=>{
  document.body.classList.toggle("cb");
  localStorage.setItem("bf_cb_v3",document.body.classList.contains("cb"));
};
document.getElementById("startBtn").onclick=()=>{
  tutorialEl.classList.add("hidden");
  localStorage.setItem("bf_tutorial_v3","1");
};
if(localStorage.getItem("bf_cb_v3")==="true") document.body.classList.add("cb");
if(!localStorage.getItem("bf_tutorial_v3")) tutorialEl.classList.remove("hidden");

/* ---------- START ---------- */
reset();

/* ---------- SERVICE WORKER ---------- */
if("serviceWorker"in navigator){
  const sw=`
    self.addEventListener('install',e=>{
      e.waitUntil(caches.open('bf-v3').then(c=>c.addAll(['./'])));
      self.skipWaiting();
    });
    self.addEventListener('fetch',e=>{
      e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
    });
  `;
  navigator.serviceWorker.register(
    URL.createObjectURL(new Blob([sw],{type:'text/javascript'}))
  );
}

})();
</script>
</body>
</html>
